<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Workout Activity Visualizations</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="styles.css">

  <style>
    /*body {*/
    /*  font-family: sans-serif;*/
    /*  background: #f9f9f9;*/
    /*  padding: 20px;*/
    /*}*/

    /*h2 {*/
    /*  text-align: center;*/
    /*}*/

    .charts-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
    }

    svg {
      background: white;
    }

    .tooltip {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      padding: 6px 12px;
      font-size: 13px;
      pointer-events: none;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 10px;
      font-size: 13px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      margin-right: 6px;
    }
  </style>
</head>
<body>

<h2>Workout Activity Visualizations</h2>

<div class="legend" id="legend"></div>

<div class="charts-container">
  <svg id="donutChart" width="500" height="500"></svg>
  <svg id="stackedBarChart" width="800" height="500"></svg>
</div>

<div class="tooltip" style="opacity: 0;"></div>

<script>
  const activityLabels = [
    'Walking',
    'Elliptical',
    'Running',
    'FunctionalStrengthTraining',
    'Swimming',
    'Other',
    'Cycling',
    'UnderwaterDiving'
  ];

  const labelMap = {
    'HKWorkoutActivityTypeWalking': 'Walking',
    'HKWorkoutActivityTypeElliptical': 'Elliptical',
    'HKWorkoutActivityTypeRunning': 'Running',
    'HKWorkoutActivityTypeFunctionalStrengthTraining': 'FunctionalStrengthTraining',
    'HKWorkoutActivityTypeSwimming': 'Swimming',
    'HKWorkoutActivityTypeOther': 'Other',
    'HKWorkoutActivityTypeCycling': 'Cycling',
    'HKWorkoutActivityTypeUnderwaterDiving': 'UnderwaterDiving'
  };

  const color = d3.scaleOrdinal()
          .domain(activityLabels)
          .range(d3.schemeTableau10);

  const tooltip = d3.select(".tooltip");

  // RENDER LEGEND
  const legend = d3.select("#legend");
  activityLabels.forEach(label => {
    const item = legend.append("div").attr("class", "legend-item");
    item.append("div").attr("class", "legend-color").style("background-color", color(label));
    item.append("span").text(label);
  });

  // DONUT CHART
  d3.csv("./data/breakout_by_workout_type.csv").then(data => {
    const width = 500, height = 500, radius = Math.min(width, height) / 2;
    const svg = d3.select("#donutChart")
            .append("g")
            .attr("transform", `translate(${width/2},${height/2})`);

    const pie = d3.pie().value(d => +d.count).sort(null);
    const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius - 10);

    svg.selectAll("path")
            .data(pie(data))
            .join("path")
            .attr("d", arc)
            .attr("fill", d => color(labelMap[d.data.workoutActivityType]))
            .on("mousemove", (event, d) => {
              const total = d3.sum(data, d => +d.count);
              const percent = ((d.data.count / total) * 100).toFixed(1);
              tooltip
                      .style("opacity", 1)
                      .style("left", (event.pageX + 10) + "px")
                      .style("top", (event.pageY - 28) + "px")
                      .html(`<strong>${labelMap[d.data.workoutActivityType]}</strong><br/>${percent}%`);
            })
            .on("mouseout", () => tooltip.style("opacity", 0));
  });

  // STACKED BAR CHART
  d3.csv("./data/activity_summary_by_year.csv").then(data => {
    const keys = data.columns.slice(1); // Should match activityLabels
    const stackedData = d3.stack().keys(keys)(data.map(d => {
      d.year = +d.year;
      keys.forEach(k => d[k] = +d[k]);
      return d;
    }));

    const svg = d3.select("#stackedBarChart"),
            margin = {top: 20, right: 20, bottom: 40, left: 50},
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom;

    const chart = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

    const x = d3.scaleBand()
            .domain(data.map(d => d.year))
            .range([0, width])
            .padding(0.1);

    const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d3.sum(keys, k => +d[k]))]).nice()
            .range([height, 0]);

    chart.append("g")
            .selectAll("g")
            .data(stackedData)
            .join("g")
            .attr("fill", d => color(d.key))
            .selectAll("rect")
            .data(d => d)
            .join("rect")
            .attr("x", d => x(d.data.year))
            .attr("y", d => y(d[1]))
            .attr("height", d => y(d[0]) - y(d[1]))
            .attr("width", x.bandwidth())
            .on("mousemove", (event, d) => {
              const key = d3.select(event.target.parentNode).datum().key;
              tooltip
                      .style("opacity", 1)
                      .style("left", (event.pageX + 10) + "px")
                      .style("top", (event.pageY - 28) + "px")
                      .html(`<strong>${key}</strong><br/>Count: ${d.data[key]}`);
            })
            .on("mouseout", () => tooltip.style("opacity", 0));

    chart.append("g").call(d3.axisLeft(y));

    chart.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).tickFormat(d3.format("d")));
  });
</script>

</body>
</html>
