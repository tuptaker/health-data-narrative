<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3 Route Animation with Zoom</title>
    <style>
        body {
            margin: 0;
            background: #477740;
        }
        svg {
            width: 100%;
            height: 100vh;
        }
        #timestamp {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            font-family: sans-serif;
            font-size: 16px;
            z-index: 1000;
            border-radius: 4px;
            line-height: 1.5em;
        }
    </style>
</head>
<body>
<div id="timestamp">Loading route...</div>
<svg></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script>
    const svg = d3.select("svg");
    const width = window.innerWidth;
    const height = window.innerHeight;
    const g = svg.append("g");
    const timestampDiv = document.getElementById("timestamp");

    const formatEST = (date) => {
        const options = { timeZone: 'America/New_York' };
        const estDate = new Date(date.toLocaleString('en-US', options));
        const day = estDate.getDate();
        const month = estDate.toLocaleString('en-US', { month: 'long' });
        const year = estDate.getFullYear();
        let hours = estDate.getHours();
        const minutes = estDate.getMinutes().toString().padStart(2, '0');
        const seconds = estDate.getSeconds().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        return {
            dateStr: `${day}-${month}-${year}`,
            timeStr: `${hours}:${minutes}:${seconds} ${ampm}`
        };
    };

    const haversineMiles = (lat1, lon1, lat2, lon2) => {
        const R = 3958.8;
        const toRad = d => d * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
        return 2 * R * Math.asin(Math.sqrt(a));
    };

    Promise.all([
        d3.json("../tri_town_combined_cleaned.topojson"),
        d3.json("../geojson/route_2022-06-21_7.26pm.json")
    ]).then(([topoData, routeData]) => {
        const features = routeData.features[0];
        const coords = features.geometry.coordinates;
        const times = features.properties.coordTimes.map(d => new Date(d));
        const latlngs = coords.map(d => [d[1], d[0]]);

        const projection = d3.geoMercator().fitSize([width, height], {
            type: "LineString",
            coordinates: coords
        });
        const path = d3.geoPath().projection(projection);

        const buildingFeatures = topojson.feature(topoData, topoData.objects['tri_town_buildings']).features;
        g.selectAll(".building")
            .data(buildingFeatures)
            .enter().append("path")
            .attr("class", "building")
            .attr("d", path)
            .attr("fill", "#f4b6b6")
            .attr("stroke", "#333")
            .attr("stroke-width", 0.2);

        const roadFeatures = topojson.feature(topoData, topoData.objects['tri_town_roads']).features;
        g.selectAll(".road")
            .data(roadFeatures)
            .enter().append("path")
            .attr("class", "road")
            .attr("d", path)
            .attr("fill", "none")
            .attr("stroke", "#333")
            .attr("stroke-width", 14.7);

        g.selectAll(".road-label")
            .data(roadFeatures.filter(d => d.properties.name))
            .enter()
            .append("text")
            .attr("class", "road-label")
            .attr("x", d => path.centroid(d)[0])
            .attr("y", d => path.centroid(d)[1])
            .attr("text-anchor", "middle")
            .attr("font-size", "10px")
            .attr("fill", "#ffffff")
            .text(d => d.properties.name);

        g.selectAll(".building-label")
            .data(buildingFeatures.filter(d => d.properties['addr:housenumber']))
            .enter()
            .append("text")
            .attr("class", "building-label")
            .attr("x", d => path.centroid(d)[0])
            .attr("y", d => path.centroid(d)[1])
            .attr("text-anchor", "middle")
            .attr("font-size", "8px")
            .attr("fill", "#000000")
            .text(d => d.properties['addr:housenumber']);

        const line = d3.line()
            .x(d => projection([d[1], d[0]])[0])
            .y(d => projection([d[1], d[0]])[1]);

        const routePath = g.append("path")
            .datum(latlngs)
            .attr("d", line)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 2)
            .attr("stroke-linejoin", "round");

        const marker = g.append("circle")
            .attr("r", 6)
            .attr("fill", "orange")
            .attr("stroke", "black")
            .attr("stroke-width", 1.5);

        let i = 1;
        const startTime = times[0];
        function animate() {
            if (i >= latlngs.length) return;

            const prev = latlngs[i - 1];
            const curr = latlngs[i];
            const prevTime = times[i - 1];
            const currTime = times[i];

            const pos = projection(curr.reverse());
            marker.attr("cx", pos[0]).attr("cy", pos[1]);
            curr.reverse();

            const elapsedMs = currTime - startTime;
            const elapsed = new Date(elapsedMs).toISOString().substr(11, 8);
            const miles = haversineMiles(prev[0], prev[1], curr[0], curr[1]);
            const deltaSec = (currTime - prevTime) / 1000;
            let pace = "N/A";
            if (miles > 0) {
                const minPerMile = (deltaSec / 60) / miles;
                const min = Math.floor(minPerMile);
                const sec = Math.round((minPerMile - min) * 60);
                pace = `${min}:${sec.toString().padStart(2, '0')} min/mile`;
            }
            const { dateStr, timeStr } = formatEST(currTime);
            timestampDiv.innerHTML = `
                <strong>Date:</strong> ${dateStr}<br/>
                <strong>Time:</strong> ${timeStr}<br/>
                <strong>Elapsed:</strong> ${elapsed}<br/>
                <strong>Speed:</strong> ${pace}`;

            i++;
            setTimeout(animate, 50);
        }

        animate();

        const zoom = d3.zoom().on("zoom", ({transform}) => {
            g.attr("transform", transform);
        });

        svg.call(zoom);
    });
</script>
</body>
</html>
